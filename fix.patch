 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/mobile/App.js b/mobile/App.js
index 871cf82ebc131c3da7071f24027f310994a50552..25fcef144831fc564d0090d8979008dd6e64f0f1 100644
--- a/mobile/App.js
+++ b/mobile/App.js
@@ -1,48 +1,48 @@
 import React, { useState, useEffect, useCallback, useMemo, useRef } from "react";
 import {
   Text,
   View,
   StyleSheet,
   TextInput,
   Button,
   Alert,
   ActivityIndicator,
   ScrollView,
   TouchableOpacity,
   Switch,
   Linking,
   Platform,
   Image,
   KeyboardAvoidingView,
   TouchableWithoutFeedback,
   Keyboard,
   Pressable,
   RefreshControl,
   Share,
-  AppState,
 } from "react-native";
+import * as ExpoLinking from "expo-linking";
 import {
   NavigationContainer,
   CommonActions,
   TabActions,
   useFocusEffect,
   useIsFocused,
 } from "@react-navigation/native";
 import { createBottomTabNavigator } from "@react-navigation/bottom-tabs";
 import { enableScreens } from "react-native-screens";
 import axios from "axios";
 import AsyncStorage from "@react-native-async-storage/async-storage";
 import { clearToken, loadToken, saveToken } from "./src/components/tokenStorage";
 import ProviderCard from "./src/components/ProviderCard";
 import { createApiClient } from "./src/api/client";
 import * as Location from "expo-location";
 import Constants from "expo-constants";
 import * as ImagePicker from "expo-image-picker";
 import { Ionicons } from "@expo/vector-icons";
 import { SafeAreaProvider,SafeAreaView } from "react-native-safe-area-context";
 import BookitGYLogoTransparent from "./assets/bookitgy-logo-transparent.png"
 import { theme } from "./src/theme";
 // import * as Sentry from "sentry-expo";
 
 let Clipboard = null;
 try {
@@ -2741,56 +2741,58 @@ function SearchScreen({ token, showFlash, navigation, route, toggleFavorite, isF
   const [selectedService, setSelectedService] = useState(null);
   const [catalogImages, setCatalogImages] = useState([]);
   const [catalogLoading, setCatalogLoading] = useState(false);
   const [catalogError, setCatalogError] = useState("");
   const [availability, setAvailability] = useState([]);
   const [availabilityLoading, setAvailabilityLoading] = useState(false);
   const [availabilityError, setAvailabilityError] = useState("");
   const [selectedDate, setSelectedDate] = useState(null);
   const [selectedSlot, setSelectedSlot] = useState(null); // ISO string
   const [bookingLoading, setBookingLoading] = useState(false);
   const [hasSearched, setHasSearched] = useState(false); // ðŸ‘ˆ NEW
   const [refreshing, setRefreshing] = useState(false);
   const [shouldScrollToResults, setShouldScrollToResults] = useState(false);
   const isFocused = useIsFocused();
   const scrollRef = useRef(null);
   const resultsOffset = useRef(0);
   //Radius 
   const distanceChips = [0, 5, 10, 15, 20];
 
   useEffect(() => {
     if (!isFocused) return;
     if (!incomingUsername) return;
     console.log(
       "[deeplink] consumed in SearchScreen",
       incomingUsername,
-      deeplinkNonce
+      deeplinkNonce,
+      "focused",
+      isFocused
     );
     setSearchQuery(incomingUsername);
     setHasSearched(true);
     setShouldScrollToResults(true);
-  }, [isFocused, incomingUsername, deeplinkNonce]);
+  }, [incomingUsername, deeplinkNonce, isFocused]);
 
   const haversineKm = (lat1, lon1, lat2, lon2) => {
     if (
       lat1 == null ||
       lon1 == null ||
       lat2 == null ||
       lon2 == null
     ) {
       return null;
     }
     const toRad = (v) => (v * Math.PI) / 180;
     const R = 6371; // km
     const dLat = toRad(lat2 - lat1);
     const dLon = toRad(lon2 - lon1);
     const a =
       Math.sin(dLat / 2) * Math.sin(dLat / 2) +
       Math.cos(toRad(lat1)) *
         Math.cos(toRad(lat2)) *
         Math.sin(dLon / 2) *
         Math.sin(dLon / 2);
     const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
     return R * c;
   };
 
 
@@ -6105,50 +6107,52 @@ function FlashMessage({ flash }) {
   );
 }
 
 
 // ðŸ”¹ App orchestrates landing/login/signup/forgot-password vs main app
 
 const DEEPLINK_DEBUG = true;
 
 function App() {
 
   const mountIdRef = useRef(Math.random().toString(16).slice(2));
   console.log("APP MOUNT ID:", mountIdRef.current);
   useEffect(() => console.log("APP useEffect ran for mount", mountIdRef.current), []);
 
   const [token, setToken] = useState(null);
   const [authLoading, setAuthLoading] = useState(true);
   const [authMode, setAuthMode] = useState("landing"); // 'landing' | 'login' | 'signup' | 'forgot'
   const [isAdmin, setIsAdmin] = useState(false);
   const [pendingDeepLinkUsername, setPendingDeepLinkUsername] = useState(null);
   const [navReady, setNavReady] = useState(false);
   const navReadyRef = useRef(false);
   const navigationRef = useRef(null);
   const authBootstrapRef = useRef({ inFlight: false, completed: false });
   const tokenRef = useRef(token);
   const lastDeeplinkHandledAtRef = useRef(0);
+  const lastHandledUrlRef = useRef(null);
+  const url = ExpoLinking.useURL();
 
   const [flash, setFlash] = useState(null);
   const handleUnauthorized = useCallback(async () => {
     try {
       await AsyncStorage.removeItem(LEGACY_ACCESS_TOKEN_KEY);
     } catch (storageError) {
       console.log(
         "[auth] Failed to clear legacy token",
         storageError?.message || storageError
       );
     }
     setToken(null);
   }, []);
 
   const apiClient = useMemo(
     () =>
       createApiClient({
         baseURL: API,
         onUnauthorized: handleUnauthorized,
       }),
     [handleUnauthorized]
   );
 
 
 
@@ -6186,113 +6190,117 @@ function App() {
     return String(text);
   }, []);
 
   const showFlash = useCallback((type, text) => {
     setFlash({ type, text: formatFlashText(text) });
     setTimeout(() => {
       setFlash(null);
     }, 4500);
   }, [formatFlashText]);
 
   useEffect(() => {
     tokenRef.current = token;
   }, [token]);
 
   useEffect(() => {
     navReadyRef.current = navReady;
   }, [navReady]);
 
   useEffect(() => {
     if (!token) setNavReady(false);
   }, [token]);
 
   const handleIncomingUrl = useCallback((url, source) => {
     console.log("[deeplink] handleIncomingUrl", source, url);
     if (DEEPLINK_DEBUG) showFlash("info", `[DL] ${source}: ${url || "(null)"}`);
+    if (url && url === lastHandledUrlRef.current) {
+      console.log("[deeplink] duplicate url ignored", url);
+      return false;
+    }
     const username = extractUsernameFromUrl(url);
     console.log("[deeplink] extracted username", username);
     if (!username) {
       if (DEEPLINK_DEBUG) showFlash("error", "[DL] parse failed");
       return false;
     }
     if (DEEPLINK_DEBUG) showFlash("success", `[DL] user: ${username}`);
-    lastDeeplinkHandledAtRef.current = Date.now();
-
     if (tokenRef.current?.isProvider === true) {
       showFlash("error", "Open as a client to view provider links.");
       return true;
     }
 
+    lastHandledUrlRef.current = url;
+    lastDeeplinkHandledAtRef.current = Date.now();
+
     const queued = { username, nonce: Date.now() };
     console.log("[deeplink] queued", queued.username, queued.nonce);
     setPendingDeepLinkUsername(queued);
     return true;
   }, [showFlash]);
 
   useEffect(() => {
     let isActive = true;
 
     Linking.getInitialURL().then((url) => {
       if (!isActive) return;
       console.log("[deeplink] getInitialURL", url);
       if (DEEPLINK_DEBUG) {
         showFlash("info", `[DL] getInitialURL: ${url || "(null)"}`);
       }
       if (url) handleIncomingUrl(url, "initial");
     });
 
     const sub = Linking.addEventListener("url", ({ url }) => {
       console.log("[deeplink] url event", url);
       handleIncomingUrl(url, "event");
     });
 
     return () => {
       isActive = false;
       sub.remove();
     };
   }, [handleIncomingUrl]);
 
   useEffect(() => {
-    const sub = AppState.addEventListener("change", (nextState) => {
-      if (nextState !== "active") return;
-      Linking.getInitialURL().then((url) => {
-        console.log("[deeplink] getInitialURL (active)", url);
-        if (DEEPLINK_DEBUG) {
-          showFlash("info", `[DL] getInitialURL(active): ${url || "(null)"}`);
-        }
-        if (!url || url === lastHandledUrlRef.current) return;
-        handleIncomingUrl(url, "appstate-active");
-      });
-    });
-
-    return () => {
-      sub.remove();
-    };
-  }, [handleIncomingUrl]);
+    if (!url) return;
+    console.log("[deeplink] useURL update", url);
+    handleIncomingUrl(url, "useURL");
+  }, [handleIncomingUrl, url]);
 
   useEffect(() => {
     if (!pendingDeepLinkUsername) return;
+    console.log(
+      "[deeplink] pending checks",
+      "hasToken",
+      Boolean(token),
+      "isProvider",
+      token?.isProvider,
+      "navReady",
+      navReady,
+      "navRef",
+      Boolean(navigationRef.current)
+    );
     if (!token) return;
     if (token.isProvider) {
       showFlash("error", "Open as a client to view provider links.");
       setPendingDeepLinkUsername(null);
       return;
     }
     if (!navReady) return;
     if (!navigationRef.current) return;
 
     const ok = navigateToClientSearch(
       pendingDeepLinkUsername.username,
       navigationRef,
       pendingDeepLinkUsername.nonce
     );
     console.log(
       "[deeplink] pending navigate attempt",
       pendingDeepLinkUsername.username,
       "ok",
       ok
     );
     if (ok) setPendingDeepLinkUsername(null);
   }, [pendingDeepLinkUsername, token, navReady, showFlash]);
 
   useEffect(() => {
     let isActive = true;
 
EOF
)