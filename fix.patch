 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/backend/app/crud.py b/backend/app/crud.py
index 147234b3fe78ab8ad5e0670236fc60e0e6cff5e7..ad05de0b9e357ff56c6bb427eb9d345202034d95 100644
--- a/backend/app/crud.py
+++ b/backend/app/crud.py
@@ -379,51 +379,58 @@ def notify_booking_created(
 # User CRUD + authentication
 # ---------------------------------------------------------------------------
 
 def create_user(db: Session, user: schemas.UserCreate) -> models.User:
     """Create a new user with hashed password."""
     hashed = hash_password(user.password)
     user_data = user.dict(exclude={"password"})
     user_data["username"] = normalize_username(user.username)
     db_user = models.User(
         **user_data,
         hashed_password=hashed,
         is_email_verified=False,
     )
     db.add(db_user)
     try:
         db.commit()
     except IntegrityError:
         db.rollback()
         raise
     db.refresh(db_user)
     return db_user
 
 
 def get_user_by_email(db: Session, email: str):
     """Return user by email, or None if not found."""
-    return db.query(models.User).filter(models.User.email == email).first()
+    if not email:
+        return None
+    normalized = email.strip().lower()
+    return (
+        db.query(models.User)
+        .filter(func.lower(models.User.email) == normalized)
+        .first()
+    )
 
 
 def get_user_by_id(db: Session, user_id: int):
     """Return user by id, or None if not found."""
     return db.query(models.User).filter(models.User.id == user_id).first()
 
 
 def get_user_by_username(db: Session, username: str):
     """Return user by username, or None if not found."""
     normalized = normalize_username(username)
     return (
         db.query(models.User)
         .filter(func.lower(models.User.username) == normalized)
         .first()
     )
 
 
 def authenticate_user(db: Session, email: str, password: str):
     """
     Authenticate a user by email + password.
 
     Returns:
         - user object if credentials are valid
         - None if invalid
     """
 
EOF
)