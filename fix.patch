 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/mobile/plugins/strip-pods-privacyinfo.js b/mobile/plugins/strip-pods-privacyinfo.js
index 1fec004e58c72ddc51ae26f3276ee20785e50d09..98874ca947b33f831e6ff46a99ed73644f2e9d54 100644
--- a/mobile/plugins/strip-pods-privacyinfo.js
+++ b/mobile/plugins/strip-pods-privacyinfo.js
@@ -102,62 +102,70 @@ function processPbxproj(pbxprojPath) {
   updated = buildFilesStrip.content;
 
   const fileRefsStrip = stripEntries(updated, fileRefsToRemove, "PrivacyInfo.xcprivacy");
   updated = fileRefsStrip.content;
 
   const resourcesStrip = stripResourcesReferences(updated, buildFilesToRemove);
   updated = resourcesStrip.content;
 
   if (updated !== original) {
     fs.writeFileSync(pbxprojPath, updated);
   }
 
   const totalRemoved = buildFilesStrip.removed + fileRefsStrip.removed + resourcesStrip.removed;
   console.log(
     `[strip-pods-privacyinfo] Removed ${totalRemoved} PrivacyInfo.xcprivacy references from ${path.relative(
       process.cwd(),
       pbxprojPath
     )}`
   );
 }
 
 function buildPodfileSnippet(indent) {
   const lines = [
     `${indent}${PODFILE_MARKER}`,
     `${indent}pods_project = installer.pods_project`,
-    "",
     `${indent}removed = 0`,
+    "",
     `${indent}pods_project.targets.each do |t|`,
+    `${indent}  # PBXAggregateTarget and others may not have resources build phase`,
+    `${indent}  next unless t.respond_to?(:resources_build_phase)`,
+    "",
     `${indent}  phase = t.resources_build_phase`,
-    `${indent}  next unless phase && phase.files`,
+    `${indent}  next unless phase && phase.respond_to?(:files) && phase.files`,
     "",
     `${indent}  phase.files.to_a.each do |bf|`,
-    `${indent}    ref = bf.file_ref`,
-    `${indent}    next unless ref && ref.path`,
-    `${indent}    next unless ref.path.end_with?("PrivacyInfo.xcprivacy")`,
+    `${indent}    ref = bf.respond_to?(:file_ref) ? bf.file_ref : nil`,
+    `${indent}    ref_path = ref && ref.respond_to?(:path) ? ref.path : nil`,
+    `${indent}    next unless ref_path && ref_path.end_with?("PrivacyInfo.xcprivacy")`,
     "",
-    `${indent}    phase.remove_build_file(bf)`,
+    `${indent}    # remove build file safely`,
+    `${indent}    if phase.respond_to?(:remove_build_file)`,
+    `${indent}      phase.remove_build_file(bf)`,
+    `${indent}    else`,
+    `${indent}      phase.files.delete(bf)`,
+    `${indent}    end`,
     `${indent}    removed += 1`,
     `${indent}  end`,
     `${indent}end`,
     "",
     `${indent}pods_project.save`,
     `${indent}puts "[BookitGY] Removed #{removed} PrivacyInfo.xcprivacy resource refs from Pods project"`,
     "",
   ];
 
   return lines.join("\n");
 }
 
 function findPostInstallEnd(content, startIndex) {
   const remainder = content.slice(startIndex);
   const lines = remainder.split("\n");
   let depth = 0;
   let position = startIndex;
 
   for (const line of lines) {
     const lineStart = position;
     const doCount = (line.match(/\bdo\b/g) || []).length;
     const endCount = (line.match(/\bend\b/g) || []).length;
 
     depth += doCount;
     depth -= endCount;
 
EOF
)