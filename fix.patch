 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/backend/app/crud.py b/backend/app/crud.py
index f34715b7f4fef05859f26bdde2ec7fe24c1ab080..b1ecfcaaf1b69d3958c9c0db5efc4b4dd633fc42 100644
--- a/backend/app/crud.py
+++ b/backend/app/crud.py
@@ -1339,66 +1339,70 @@ def list_bookings_for_customer(db: Session, customer_id: int):
                 service_price_gyd=(
                     float(service.price_gyd or 0.0)
                     if service and service.price_gyd is not None
                     else 0.0
                 ),
                 customer_name=get_display_name(user),
                 customer_phone=user.phone or "",
                 provider_name=provider_name,
                 provider_location=provider_location,
                 provider_lat=provider_lat,
                 provider_long=provider_long,
             )
         )
 
     return results
 
 
 
 def cancel_booking_for_customer(
     db: Session, booking_id: int, customer_id: int
 ) -> Optional[models.Booking]:
     """
     Cancel a booking for a given customer.
 
     Returns the updated booking or None if not found / not owned by customer.
+    If the booking has already been auto-completed, this still forces the status
+    back to "cancelled" so it won't be billed.
     """
     booking = (
         db.query(models.Booking)
         .filter(
             models.Booking.id == booking_id,
             models.Booking.customer_id == customer_id,
         )
         .first()
     )
 
     if not booking:
         return None
 
-    # Only allow cancellation from certain states
-    if booking.status not in ("confirmed", "pending"):
-        return booking  # already cancelled/completed, no-op
+    normalized_status = (booking.status or "").strip().lower()
+
+    # If it's already cancelled, nothing to do
+    if normalized_status in {"cancelled", "canceled"}:
+        return booking
 
     booking.status = "cancelled"
     db.commit()
     db.refresh(booking)
 
     service = (
         db.query(models.Service)
         .filter(models.Service.id == booking.service_id)
         .first()
     )
     provider_user = None
     if service:
         provider = (
             db.query(models.Provider)
             .filter(models.Provider.id == service.provider_id)
             .first()
         )
         if provider:
             provider_user = (
                 db.query(models.User)
                 .filter(models.User.id == provider.user_id)
                 .first()
             )
 
     customer = (
 
EOF
)