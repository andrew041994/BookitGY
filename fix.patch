 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/mobile/App.js b/mobile/App.js
index 676022e47edfe170e985559aa9771befae12e1db..06e13199796e21656ceee2b18f20597215349be2 100644
--- a/mobile/App.js
+++ b/mobile/App.js
@@ -1,51 +1,50 @@
 import React, { useState, useEffect, useCallback, useMemo, useRef } from "react";
 import {
   Text,
   View,
   StyleSheet,
   TextInput,
   Button,
   Alert,
   ActivityIndicator,
   ScrollView,
   TouchableOpacity,
   Switch,
   Linking,
   Platform,
   Image,
   KeyboardAvoidingView,
   TouchableWithoutFeedback,
   Keyboard,
   Pressable,
   RefreshControl,
   Share,
 } from "react-native";
 import * as ExpoLinking from "expo-linking";
 import {
   NavigationContainer,
-  CommonActions,
   TabActions,
   useFocusEffect,
   useIsFocused,
 } from "@react-navigation/native";
 import { createBottomTabNavigator } from "@react-navigation/bottom-tabs";
 import { enableScreens } from "react-native-screens";
 import axios from "axios";
 import AsyncStorage from "@react-native-async-storage/async-storage";
 import { clearToken, loadToken, saveToken } from "./src/components/tokenStorage";
 import ProviderCard from "./src/components/ProviderCard";
 import { createApiClient } from "./src/api/client";
 import * as Location from "expo-location";
 import Constants from "expo-constants";
 import * as ImagePicker from "expo-image-picker";
 import { Ionicons } from "@expo/vector-icons";
 import { SafeAreaProvider,SafeAreaView } from "react-native-safe-area-context";
 import BookitGYLogoTransparent from "./assets/bookitgy-logo-transparent.png"
 import { theme } from "./src/theme";
 // import * as Sentry from "sentry-expo";
 
 let Clipboard = null;
 try {
   Clipboard = require("expo-clipboard");
 } catch (e) {}
 
@@ -211,66 +210,62 @@ function buildProviderPublicLink(username) {
   if (!trimmed) return null;
   return `https://bookitgy.com/u/${encodeURIComponent(trimmed)}`;
 }
 
 // function navigateToClientSearch(username, navigationRef, nonce) {
 //   if (!navigationRef?.current) return false;
 
 //   const params = { incomingUsername: username, deeplinkNonce: nonce };
 
 //   navigationRef.current.dispatch(
 //     CommonActions.reset({
 //       index: 1,
 //       routes: [
 //         { name: "Home" },
 //         { name: "Search", params },
 //         { name: "Appointments" },
 //         { name: "Profile" },
 //       ],
 //     })
 //   );
 
 //   return true;
 // }
 
 
-function navigateToClientSearch(username, navigationRef, nonce) {
-  if (!navigationRef?.current) return false;
-
-  const params = { incomingUsername: username, deeplinkNonce: nonce };
-
-  // 1ï¸âƒ£ Always force the tab switch
-  navigationRef.current.dispatch(TabActions.jumpTo("Search"));
-
-  // 2ï¸âƒ£ Explicitly update params on Search route
-  navigationRef.current.dispatch(
-    CommonActions.setParams(params)
+function findClientTabsKey(state) {
+  if (!state || !Array.isArray(state.routes)) return null;
+  const routeNames = state.routes.map((route) => route?.name);
+  const hasClientTabs = ["Home", "Search", "Appointments", "Profile"].every(
+    (name) => routeNames.includes(name)
   );
-
-  console.log("[deeplink] forced Search tab + params", params);
-
-  return true;
+  if (hasClientTabs && state.key) return state.key;
+  for (const route of state.routes) {
+    const nestedKey = findClientTabsKey(route?.state);
+    if (nestedKey) return nestedKey;
+  }
+  return null;
 }
 
 
 
 function useFavoriteProviders(userKey) {
   const storageKey = FAVORITES_STORAGE_KEY(userKey);
   const [favoriteIds, setFavoriteIds] = useState([]);
   const [favoriteProviders, setFavoriteProviders] = useState([]);
   const [favoritesLoading, setFavoritesLoading] = useState(true);
 
   const persistIds = useCallback(async (ids) => {
     try {
       await AsyncStorage.setItem(storageKey, JSON.stringify(ids));
     } catch (err) {
       console.log("Error saving favorites", err?.message || err);
     }
   }, [storageKey]);
 
   const loadFavoritesFromStorage = useCallback(async () => {
     try {
       setFavoritesLoading(true);
       const raw = await AsyncStorage.getItem(storageKey);
       const parsed = raw ? JSON.parse(raw) : [];
       setFavoriteIds(Array.isArray(parsed) ? parsed : []);
     } catch (err) {
@@ -5854,69 +5849,76 @@ function ProviderBillingScreen({ token, showFlash }) {
                 <Text style={styles.billingTotalsValue}>
                   -{formatMoney(bill.bill_credits_gyd)}
                 </Text>
               </View>
             <View style={styles.billingTotalsRow}>
               <Text style={styles.billingTotalsLabel}>Total due</Text>
               <Text style={styles.billingTotalsValue}>
                 {formatMoney(bill.total_due_gyd)}
               </Text>
             </View>
           </View>
         )})}
     </ScrollView>
   );
 }
 
 
 // Tabs after login
 function MainApp({
   apiClient,
   authLoading,
   token,
   setToken,
   showFlash,
   navigationRef,
+  clientTabsKeyRef,
   setNavReady,
 }) {
   const {
     favoriteIds,
     favoriteProviders,
     favoritesLoading,
     toggleFavorite,
     isFavorite,
     syncFavoritesFromList,
     refreshFavoriteProviders,
   } = useFavoriteProviders(token?.email || token?.userId);
   return (
 
     <NavigationContainer
       ref={navigationRef}
       onReady={() => {
         console.log("[nav] ready");
         setNavReady(true);
       }}
+      onStateChange={() => {
+        if (token.isProvider) return;
+        const rootState = navigationRef.current?.getRootState();
+        clientTabsKeyRef.current = findClientTabsKey(rootState);
+        console.log("[nav] tabs key", clientTabsKeyRef.current);
+      }}
     >
       {token.isProvider ? (
         // ðŸ‘‡ Provider view: Dashboard + Billing + Profile
         <Tab.Navigator
           initialRouteName="Dashboard"
           screenOptions={({ route }) => ({
             headerShown: false,
             tabBarShowLabel: true,
             tabBarActiveTintColor: colors.primary,
             tabBarInactiveTintColor: colors.textSecondary,
             tabBarStyle: {
               backgroundColor: colors.surface,
               height: 76,
               paddingBottom: Platform.OS === "ios" ? 24 : 12,
               paddingTop: 8,
               borderTopWidth: 1,
               borderTopColor: colors.border,
               shadowColor: "#000",
               shadowOpacity: 0.08,
               shadowRadius: 12,
               shadowOffset: { width: 0, height: -2 },
               elevation: 8,
             },
             tabBarLabel: ({ focused, color }) => (
               <Text
@@ -6126,50 +6128,51 @@ function FlashMessage({ flash }) {
         {flash.text}
       </Text>
     </View>
   );
 }
 
 
 // ðŸ”¹ App orchestrates landing/login/signup/forgot-password vs main app
 
 const DEEPLINK_DEBUG = true;
 
 function App() {
 
   const mountIdRef = useRef(Math.random().toString(16).slice(2));
   console.log("APP MOUNT ID:", mountIdRef.current);
   useEffect(() => console.log("APP useEffect ran for mount", mountIdRef.current), []);
 
   const [token, setToken] = useState(null);
   const [authLoading, setAuthLoading] = useState(true);
   const [authMode, setAuthMode] = useState("landing"); // 'landing' | 'login' | 'signup' | 'forgot'
   const [isAdmin, setIsAdmin] = useState(false);
   const [pendingDeepLinkUsername, setPendingDeepLinkUsername] = useState(null);
   const [navReady, setNavReady] = useState(false);
   const navReadyRef = useRef(false);
   const navigationRef = useRef(null);
+  const clientTabsKeyRef = useRef(null);
   const authBootstrapRef = useRef({ inFlight: false, completed: false });
   const tokenRef = useRef(token);
   const lastDeeplinkHandledAtRef = useRef(0);
   const lastHandledUrlRef = useRef(null);
   const url = ExpoLinking.useURL();
 
   const [flash, setFlash] = useState(null);
   const handleUnauthorized = useCallback(async () => {
     try {
       await AsyncStorage.removeItem(LEGACY_ACCESS_TOKEN_KEY);
     } catch (storageError) {
       console.log(
         "[auth] Failed to clear legacy token",
         storageError?.message || storageError
       );
     }
     setToken(null);
   }, []);
 
   const apiClient = useMemo(
     () =>
       createApiClient({
         baseURL: API,
         onUnauthorized: handleUnauthorized,
       }),
@@ -6209,50 +6212,73 @@ function App() {
       return JSON.stringify(text);
     }
 
     return String(text);
   }, []);
 
   const showFlash = useCallback((type, text) => {
     setFlash({ type, text: formatFlashText(text) });
     setTimeout(() => {
       setFlash(null);
     }, 4500);
   }, [formatFlashText]);
 
   useEffect(() => {
     tokenRef.current = token;
   }, [token]);
 
   useEffect(() => {
     navReadyRef.current = navReady;
   }, [navReady]);
 
   useEffect(() => {
     if (!token) setNavReady(false);
   }, [token]);
 
+  const navigateToClientSearch = useCallback(
+    (username, navRef, nonce) => {
+      if (!navRef?.current) return false;
+
+      const params = { incomingUsername: username, deeplinkNonce: nonce };
+      const targetKey = clientTabsKeyRef.current;
+      if (!targetKey) {
+        console.log("[deeplink] missing tabs key; jumpTo skipped");
+        return false;
+      }
+
+      console.log("[deeplink] jumpTo Search target", targetKey);
+      navRef.current.dispatch({
+        ...TabActions.jumpTo("Search", params),
+        target: targetKey,
+      });
+      console.log("[deeplink] jumpTo dispatched", params);
+
+      return true;
+    },
+    []
+  );
+
   const handleIncomingUrl = useCallback((url, source) => {
     console.log("[deeplink] handleIncomingUrl", source, url);
     if (DEEPLINK_DEBUG) showFlash("info", `[DL] ${source}: ${url || "(null)"}`);
     if (url && url === lastHandledUrlRef.current) {
       console.log("[deeplink] duplicate url ignored", url);
       return false;
     }
     const username = extractUsernameFromUrl(url);
     console.log("[deeplink] extracted username", username);
     if (!username) {
       if (DEEPLINK_DEBUG) showFlash("error", "[DL] parse failed");
       return false;
     }
     if (DEEPLINK_DEBUG) showFlash("success", `[DL] user: ${username}`);
     if (tokenRef.current?.isProvider === true) {
       showFlash("error", "Open as a client to view provider links.");
       return true;
     }
 
     lastHandledUrlRef.current = url;
     lastDeeplinkHandledAtRef.current = Date.now();
 
     const queued = { username, nonce: Date.now() };
     console.log("[deeplink] queued", queued.username, queued.nonce);
     setPendingDeepLinkUsername(queued);
@@ -6494,50 +6520,51 @@ function App() {
             )}
 
             {authMode === "signup" && (
               <SignupScreen
                 goToLogin={() => setAuthMode("login")}
                 goBack={() => setAuthMode("landing")}
                 showFlash={showFlash}
               />
             )}
             {authMode === "forgot" && (
               <ForgotPasswordScreen
                 goToLogin={() => setAuthMode("login")}
                 goBack={() => setAuthMode("landing")}
                 showFlash={showFlash}
               />
             )}
           </>
         ) : (
           <MainApp
             apiClient={apiClient}
             authLoading={authLoading}
             token={token}
             setToken={setToken}
             showFlash={showFlash}
             navigationRef={navigationRef}
+            clientTabsKeyRef={clientTabsKeyRef}
             setNavReady={setNavReady}
           />
         )}
       </SafeAreaView>
     </SafeAreaProvider>
   );
 }
 
 
 
 
 const styles = StyleSheet.create({
   container: {
     flex: 1,
     backgroundColor: colors.background,
     justifyContent: "center",
     alignItems: "center",
     padding: 20,
   },
   title: {
     fontSize: 36,
     fontWeight: "bold",
     color: colors.textPrimary,
     marginBottom: 20,
   },
 
EOF
)