 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/mobile/App.js b/mobile/App.js
index 1d4b54138fdb5b7073e6a45a1e25aa808c318e15..cfb0e4db215fbace85376284544117406eaf7f0d 100644
--- a/mobile/App.js
+++ b/mobile/App.js
@@ -183,80 +183,58 @@ function extractUsernameFromUrl(url) {
   if (!username) return null;
 
   let decoded = username;
   try {
     decoded = decodeURIComponent(username);
   } catch (error) {
     decoded = username;
   }
 
   const cleaned = decoded.trim().replace(/^@/, "");
   if (!cleaned || !isValidUsername(cleaned)) return null;
   return cleaned;
 }
 
 function buildProviderPublicLink(username) {
   const trimmed = String(username || "").trim();
   if (!trimmed) return null;
   return `https://bookitgy.com/u/${encodeURIComponent(trimmed)}`;
 }
 
 function navigateToClientSearch(username, navigationRef) {
   if (!navigationRef?.current) return false;
 
   const params = { incomingUsername: username, deeplinkNonce: Date.now() };
 
-  const rootState = navigationRef.current.getRootState?.();
-  const routeNames = rootState?.routeNames || [];
-
-  // If we have ClientTabs in the navigator tree, reset directly into it
-  // and land on Search with fresh params (forces navigation every time).
-  if (routeNames.includes("ClientTabs")) {
-    navigationRef.current.reset({
-      index: 0,
-      routes: [
-        {
-          name: "ClientTabs",
-          state: {
-            index: 1, // <-- put Search tab index here (0-based)
-            routes: [
-              { name: "Home" },
-              { name: "Search", params },
-              { name: "Appointments" },
-              { name: "Profile" },
-            ],
-          },
-        },
-      ],
-    });
-    return true;
-  }
-
-  // If not in tabs yet (e.g., auth stack), reset to Search directly.
   navigationRef.current.reset({
-    index: 0,
-    routes: [{ name: "Search", params }],
+    index: 1,
+    routes: [
+      { name: "Home" },
+      { name: "Search", params },
+      { name: "Appointments" },
+      { name: "Profile" },
+    ],
   });
 
   return true;
 }
 
 
 function useFavoriteProviders(userKey) {
   const storageKey = FAVORITES_STORAGE_KEY(userKey);
   const [favoriteIds, setFavoriteIds] = useState([]);
   const [favoriteProviders, setFavoriteProviders] = useState([]);
   const [favoritesLoading, setFavoritesLoading] = useState(true);
 
   const persistIds = useCallback(async (ids) => {
     try {
       await AsyncStorage.setItem(storageKey, JSON.stringify(ids));
     } catch (err) {
       console.log("Error saving favorites", err?.message || err);
     }
   }, [storageKey]);
 
   const loadFavoritesFromStorage = useCallback(async () => {
     try {
       setFavoritesLoading(true);
       const raw = await AsyncStorage.getItem(storageKey);
       const parsed = raw ? JSON.parse(raw) : [];
@@ -5819,64 +5797,73 @@ function ProviderBillingScreen({ token, showFlash }) {
               <Text style={styles.billingTotalsLabel}>Platform fee</Text>
               <Text style={styles.billingTotalsValue}>
                 {formatMoney(bill.platform_fee_gyd)}
               </Text>
             </View>
               <View style={styles.billingTotalsRow}>
                 <Text style={styles.billingTotalsLabel}>Bill credits</Text>
                 <Text style={styles.billingTotalsValue}>
                   -{formatMoney(bill.bill_credits_gyd)}
                 </Text>
               </View>
             <View style={styles.billingTotalsRow}>
               <Text style={styles.billingTotalsLabel}>Total due</Text>
               <Text style={styles.billingTotalsValue}>
                 {formatMoney(bill.total_due_gyd)}
               </Text>
             </View>
           </View>
         )})}
     </ScrollView>
   );
 }
 
 
 // Tabs after login
-function MainApp({ apiClient, authLoading, token, setToken, showFlash, navigationRef }) {
+function MainApp({
+  apiClient,
+  authLoading,
+  token,
+  setToken,
+  showFlash,
+  navigationRef,
+  setNavReady,
+}) {
   const {
     favoriteIds,
     favoriteProviders,
     favoritesLoading,
     toggleFavorite,
     isFavorite,
     syncFavoritesFromList,
     refreshFavoriteProviders,
   } = useFavoriteProviders(token?.email || token?.userId);
   return (
 
     <NavigationContainer
       ref={navigationRef}
+      onReady={() => setNavReady(true)}
     >
       {token.isProvider ? (
         // ðŸ‘‡ Provider view: Dashboard + Billing + Profile
         <Tab.Navigator
           initialRouteName="Dashboard"
           screenOptions={({ route }) => ({
             headerShown: false,
             tabBarShowLabel: true,
             tabBarActiveTintColor: colors.primary,
             tabBarInactiveTintColor: colors.textSecondary,
             tabBarStyle: {
               backgroundColor: colors.surface,
               height: 76,
               paddingBottom: Platform.OS === "ios" ? 24 : 12,
               paddingTop: 8,
               borderTopWidth: 1,
               borderTopColor: colors.border,
               shadowColor: "#000",
               shadowOpacity: 0.08,
               shadowRadius: 12,
               shadowOffset: { width: 0, height: -2 },
               elevation: 8,
             },
             tabBarLabel: ({ focused, color }) => (
               <Text
@@ -6081,206 +6068,232 @@ function FlashMessage({ flash }) {
         styles.flashContainer,
         { backgroundColor, borderColor },
       ]}
     >
       <Text style={[styles.flashText, { color: textColor }]}>
         {flash.text}
       </Text>
     </View>
   );
 }
 
 
 // ðŸ”¹ App orchestrates landing/login/signup/forgot-password vs main app
 
 function App() {
 
   const mountIdRef = useRef(Math.random().toString(16).slice(2));
   console.log("APP MOUNT ID:", mountIdRef.current);
   useEffect(() => console.log("APP useEffect ran for mount", mountIdRef.current), []);
 
   const [token, setToken] = useState(null);
   const [authLoading, setAuthLoading] = useState(true);
   const [authMode, setAuthMode] = useState("landing"); // 'landing' | 'login' | 'signup' | 'forgot'
   const [isAdmin, setIsAdmin] = useState(false);
   const [pendingDeepLinkUsername, setPendingDeepLinkUsername] = useState(null);
+  const [navReady, setNavReady] = useState(false);
   const navigationRef = useRef(null);
   const authBootstrapRef = useRef({ inFlight: false, completed: false });
   const tokenRef = useRef(token);
 
   const [flash, setFlash] = useState(null);
   const handleUnauthorized = useCallback(async () => {
     try {
       await AsyncStorage.removeItem(LEGACY_ACCESS_TOKEN_KEY);
     } catch (storageError) {
       console.log(
         "[auth] Failed to clear legacy token",
         storageError?.message || storageError
       );
     }
     setToken(null);
   }, []);
 
   const apiClient = useMemo(
     () =>
       createApiClient({
         baseURL: API,
         onUnauthorized: handleUnauthorized,
       }),
     [handleUnauthorized]
   );
 
 
 
-  const formatFlashText = (text) => {
+  const formatFlashText = useCallback((text) => {
     if (typeof text === "string") return text;
     if (text == null) return "Something went wrong.";
 
     const formatErrorItem = (item) => {
       if (typeof item === "string") return item;
       if (!item || typeof item !== "object") return String(item);
 
       const message = item.msg || item.message;
       if (Array.isArray(item.loc) && item.loc.length > 0) {
         const field = item.loc[item.loc.length - 1];
         return message ? `${field}: ${message}` : String(item);
       }
       if (message) return message;
       return JSON.stringify(item);
     };
 
     if (Array.isArray(text)) {
       return text.map(formatErrorItem).filter(Boolean).join("\n");
     }
 
     if (typeof text === "object") {
       if (Array.isArray(text.detail)) {
         return formatFlashText(text.detail);
       }
       if (typeof text.detail === "string") return text.detail;
       if (typeof text.message === "string") return text.message;
       if (typeof text.msg === "string") return text.msg;
       return JSON.stringify(text);
     }
 
     return String(text);
-  };
+  }, []);
 
-  const showFlash = (type, text) => {
+  const showFlash = useCallback((type, text) => {
     setFlash({ type, text: formatFlashText(text) });
     setTimeout(() => {
       setFlash(null);
     }, 4500);
-  };
+  }, [formatFlashText]);
 
   useEffect(() => {
     tokenRef.current = token;
   }, [token]);
 
+  useEffect(() => {
+    if (!token) setNavReady(false);
+  }, [token]);
+
   useEffect(() => {
     let isActive = true;
 
     Linking.getInitialURL().then((url) => {
       if (!isActive) return;
-      let didNavigate = false;
       console.log("[deeplink] received initial url", url);
       const username = extractUsernameFromUrl(url);
-      console.log("[deeplink] extracted username", username);
-      if (username) {
-        if (tokenRef.current && !tokenRef.current.isProvider) {
-          didNavigate = navigateToClientSearch(username, navigationRef);
-          setPendingDeepLinkUsername(null);
+      console.log(
+        "[deeplink] parsed username",
+        username,
+        "hasToken",
+        !!tokenRef.current,
+        "isProvider",
+        tokenRef.current?.isProvider,
+        "navReady",
+        navReady
+      );
+      if (!username) return;
+      if (tokenRef.current?.isProvider === true) {
+        showFlash("error", "Open as a client to view provider links.");
+        setPendingDeepLinkUsername(null);
+        return;
+      }
+      if (tokenRef.current && tokenRef.current.isProvider === false) {
+        if (navReady) {
+          const ok = navigateToClientSearch(username, navigationRef);
+          if (!ok) {
+            setPendingDeepLinkUsername({ username, nonce: Date.now() });
+          } else {
+            setPendingDeepLinkUsername(null);
+          }
         } else {
           setPendingDeepLinkUsername({ username, nonce: Date.now() });
         }
+        return;
       }
-      console.log(
-        "[deeplink] initial url",
-        url,
-        "username",
-        username,
-        "immediateNavigate",
-        didNavigate
-      );
+      setPendingDeepLinkUsername({ username, nonce: Date.now() });
     });
 
     const sub = Linking.addEventListener("url", ({ url }) => {
-      let didNavigate = false;
       console.log("[deeplink] received url event", url);
       const username = extractUsernameFromUrl(url);
-      console.log("[deeplink] extracted username", username);
-      if (username) {
-        if (tokenRef.current && !tokenRef.current.isProvider) {
-          didNavigate = navigateToClientSearch(username, navigationRef);
-          setPendingDeepLinkUsername(null);
+      console.log(
+        "[deeplink] parsed username",
+        username,
+        "hasToken",
+        !!tokenRef.current,
+        "isProvider",
+        tokenRef.current?.isProvider,
+        "navReady",
+        navReady
+      );
+      if (!username) return;
+      if (tokenRef.current?.isProvider === true) {
+        showFlash("error", "Open as a client to view provider links.");
+        setPendingDeepLinkUsername(null);
+        return;
+      }
+      if (tokenRef.current && tokenRef.current.isProvider === false) {
+        if (navReady) {
+          const ok = navigateToClientSearch(username, navigationRef);
+          if (!ok) {
+            setPendingDeepLinkUsername({ username, nonce: Date.now() });
+          } else {
+            setPendingDeepLinkUsername(null);
+          }
         } else {
           setPendingDeepLinkUsername({ username, nonce: Date.now() });
         }
+        return;
       }
-      console.log(
-        "[deeplink] url event",
-        url,
-        "username",
-        username,
-        "immediateNavigate",
-        didNavigate
-      );
+      setPendingDeepLinkUsername({ username, nonce: Date.now() });
     });
 
     return () => {
       isActive = false;
       sub.remove();
     };
-  }, []);
+  }, [navReady, showFlash]);
 
   useEffect(() => {
-    if (!pendingDeepLinkUsername || !token) return;
+    if (!pendingDeepLinkUsername) return;
+    if (!token) return;
+    if (!navReady) return;
+    if (!navigationRef.current) return;
 
     if (token.isProvider) {
-      console.log(
-        "[deeplink] provider user ignoring username",
-        pendingDeepLinkUsername.username
-      );
-      if (showFlash) {
-        showFlash("error", "Open as a client to view provider links.");
-      }
+      showFlash("error", "Open as a client to view provider links.");
       setPendingDeepLinkUsername(null);
       return;
     }
 
-    const didNavigate = navigateToClientSearch(
+    const ok = navigateToClientSearch(
       pendingDeepLinkUsername.username,
       navigationRef
     );
     console.log(
-      "[deeplink] pending username",
+      "[deeplink] pending navigate attempt",
       pendingDeepLinkUsername.username,
-      "navigate",
-      didNavigate
+      "ok",
+      ok
     );
-    setPendingDeepLinkUsername(null);
-  }, [pendingDeepLinkUsername, token, showFlash]);
+    if (ok) setPendingDeepLinkUsername(null);
+  }, [pendingDeepLinkUsername, token, navReady, showFlash]);
 
   useEffect(() => {
     let isActive = true;
     const restoreSession = async () => {
       if (authBootstrapRef.current.inFlight || authBootstrapRef.current.completed) {
         return;
       }
       authBootstrapRef.current.inFlight = true;
       const bootstrapStartedAt = Date.now();
       console.log("[auth] bootstrap start");
       try {
         const restoredToken = await withTimeout(
           getAuthToken(),
           AUTH_TOKEN_TIMEOUT_MS,
           "getAuthToken"
         );
         console.log("[auth] token loaded:", Boolean(restoredToken));
 
         if (!restoredToken) {
           if (isActive) setToken(null);
         } else {
           try {
             const meRes = await withTimeout(
               apiClient.get("/users/me", {
                 headers: {
@@ -6430,50 +6443,51 @@ function App() {
             )}
 
             {authMode === "signup" && (
               <SignupScreen
                 goToLogin={() => setAuthMode("login")}
                 goBack={() => setAuthMode("landing")}
                 showFlash={showFlash}
               />
             )}
             {authMode === "forgot" && (
               <ForgotPasswordScreen
                 goToLogin={() => setAuthMode("login")}
                 goBack={() => setAuthMode("landing")}
                 showFlash={showFlash}
               />
             )}
           </>
         ) : (
           <MainApp
             apiClient={apiClient}
             authLoading={authLoading}
             token={token}
             setToken={setToken}
             showFlash={showFlash}
             navigationRef={navigationRef}
+            setNavReady={setNavReady}
           />
         )}
       </SafeAreaView>
     </SafeAreaProvider>
   );
 }
 
 
 
 
 const styles = StyleSheet.create({
   container: {
     flex: 1,
     backgroundColor: colors.background,
     justifyContent: "center",
     alignItems: "center",
     padding: 20,
   },
   title: {
     fontSize: 36,
     fontWeight: "bold",
     color: colors.textPrimary,
     marginBottom: 20,
   },
   input: {
 
EOF
)