 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/mobile/App.js b/mobile/App.js
index d1230ed634c18c292fe7918601fdafa4b02cbb33..02ed7d507bb3bc0992dfe17e8aff74614218f2b5 100644
--- a/mobile/App.js
+++ b/mobile/App.js
@@ -211,59 +211,60 @@ function buildProviderPublicLink(username) {
   if (!trimmed) return null;
   return `https://bookitgy.com/u/${encodeURIComponent(trimmed)}`;
 }
 
 // function navigateToClientSearch(username, navigationRef, nonce) {
 //   if (!navigationRef?.current) return false;
 
 //   const params = { incomingUsername: username, deeplinkNonce: nonce };
 
 //   navigationRef.current.dispatch(
 //     CommonActions.reset({
 //       index: 1,
 //       routes: [
 //         { name: "Home" },
 //         { name: "Search", params },
 //         { name: "Appointments" },
 //         { name: "Profile" },
 //       ],
 //     })
 //   );
 
 //   return true;
 // }
 
 
-function findClientTabsKey(state) {
+function findSearchTabNavigatorKey(state) {
   if (!state || !Array.isArray(state.routes)) return null;
-  const routeNames = state.routes.map((route) => route?.name);
-  const hasClientTabs = ["Home", "Search", "Appointments", "Profile"].every(
-    (name) => routeNames.includes(name)
-  );
-  if (hasClientTabs && state.key) return state.key;
+  if (
+    state.type === "tab" &&
+    state.routes.some((route) => route?.name === "Search")
+  ) {
+    return state.key || null;
+  }
   for (const route of state.routes) {
-    const nestedKey = findClientTabsKey(route?.state);
+    const nestedKey = findSearchTabNavigatorKey(route?.state);
     if (nestedKey) return nestedKey;
   }
   return null;
 }
 
 
 
 function useFavoriteProviders(userKey) {
   const storageKey = FAVORITES_STORAGE_KEY(userKey);
   const [favoriteIds, setFavoriteIds] = useState([]);
   const [favoriteProviders, setFavoriteProviders] = useState([]);
   const [favoritesLoading, setFavoritesLoading] = useState(true);
 
   const persistIds = useCallback(async (ids) => {
     try {
       await AsyncStorage.setItem(storageKey, JSON.stringify(ids));
     } catch (err) {
       console.log("Error saving favorites", err?.message || err);
     }
   }, [storageKey]);
 
   const loadFavoritesFromStorage = useCallback(async () => {
     try {
       setFavoritesLoading(true);
       const raw = await AsyncStorage.getItem(storageKey);
@@ -5850,80 +5851,68 @@ function ProviderBillingScreen({ token, showFlash }) {
                 <Text style={styles.billingTotalsValue}>
                   -{formatMoney(bill.bill_credits_gyd)}
                 </Text>
               </View>
             <View style={styles.billingTotalsRow}>
               <Text style={styles.billingTotalsLabel}>Total due</Text>
               <Text style={styles.billingTotalsValue}>
                 {formatMoney(bill.total_due_gyd)}
               </Text>
             </View>
           </View>
         )})}
     </ScrollView>
   );
 }
 
 
 // Tabs after login
 function MainApp({
   apiClient,
   authLoading,
   token,
   setToken,
   showFlash,
   navigationRef,
-  clientTabsKeyRef,
   setNavReady,
 }) {
   const {
     favoriteIds,
     favoriteProviders,
     favoritesLoading,
     toggleFavorite,
     isFavorite,
     syncFavoritesFromList,
     refreshFavoriteProviders,
   } = useFavoriteProviders(token?.email || token?.userId);
   return (
 
     <NavigationContainer
       ref={navigationRef}
       onReady={() => {
         console.log("[nav] ready");
         setNavReady(true);
-        if (!token.isProvider) {
-          const rootState = navigationRef.current?.getRootState();
-          clientTabsKeyRef.current = findClientTabsKey(rootState);
-          console.log("[nav] tabs key (ready)", clientTabsKeyRef.current);
-         }
-      }}
-      onStateChange={() => {
-        if (token.isProvider) return;
-        const rootState = navigationRef.current?.getRootState();
-        clientTabsKeyRef.current = findClientTabsKey(rootState);
-        console.log("[nav] tabs key", clientTabsKeyRef.current);
       }}
     >
       {token.isProvider ? (
         // ðŸ‘‡ Provider view: Dashboard + Billing + Profile
         <Tab.Navigator
           initialRouteName="Dashboard"
           screenOptions={({ route }) => ({
             headerShown: false,
             tabBarShowLabel: true,
             tabBarActiveTintColor: colors.primary,
             tabBarInactiveTintColor: colors.textSecondary,
             tabBarStyle: {
               backgroundColor: colors.surface,
               height: 76,
               paddingBottom: Platform.OS === "ios" ? 24 : 12,
               paddingTop: 8,
               borderTopWidth: 1,
               borderTopColor: colors.border,
               shadowColor: "#000",
               shadowOpacity: 0.08,
               shadowRadius: 12,
               shadowOffset: { width: 0, height: -2 },
               elevation: 8,
             },
             tabBarLabel: ({ focused, color }) => (
@@ -6134,51 +6123,50 @@ function FlashMessage({ flash }) {
         {flash.text}
       </Text>
     </View>
   );
 }
 
 
 // ðŸ”¹ App orchestrates landing/login/signup/forgot-password vs main app
 
 const DEEPLINK_DEBUG = true;
 
 function App() {
 
   const mountIdRef = useRef(Math.random().toString(16).slice(2));
   console.log("APP MOUNT ID:", mountIdRef.current);
   useEffect(() => console.log("APP useEffect ran for mount", mountIdRef.current), []);
 
   const [token, setToken] = useState(null);
   const [authLoading, setAuthLoading] = useState(true);
   const [authMode, setAuthMode] = useState("landing"); // 'landing' | 'login' | 'signup' | 'forgot'
   const [isAdmin, setIsAdmin] = useState(false);
   const [pendingDeepLinkUsername, setPendingDeepLinkUsername] = useState(null);
   const [navReady, setNavReady] = useState(false);
   const navReadyRef = useRef(false);
   const navigationRef = useRef(null);
-  const clientTabsKeyRef = useRef(null);
   const authBootstrapRef = useRef({ inFlight: false, completed: false });
   const tokenRef = useRef(token);
   const lastDeeplinkHandledAtRef = useRef(0);
   const lastHandledUrlRef = useRef(null);
   const url = ExpoLinking.useURL();
 
   const [flash, setFlash] = useState(null);
   const handleUnauthorized = useCallback(async () => {
     try {
       await AsyncStorage.removeItem(LEGACY_ACCESS_TOKEN_KEY);
     } catch (storageError) {
       console.log(
         "[auth] Failed to clear legacy token",
         storageError?.message || storageError
       );
     }
     setToken(null);
   }, []);
 
   const apiClient = useMemo(
     () =>
       createApiClient({
         baseURL: API,
         onUnauthorized: handleUnauthorized,
       }),
@@ -6223,62 +6211,78 @@ function App() {
 
   const showFlash = useCallback((type, text) => {
     setFlash({ type, text: formatFlashText(text) });
     setTimeout(() => {
       setFlash(null);
     }, 4500);
   }, [formatFlashText]);
 
   useEffect(() => {
     tokenRef.current = token;
   }, [token]);
 
   useEffect(() => {
     navReadyRef.current = navReady;
   }, [navReady]);
 
   useEffect(() => {
     if (!token) setNavReady(false);
   }, [token]);
 
   const navigateToClientSearch = useCallback(
     (username, navRef, nonce) => {
       if (!navRef?.current) return false;
 
       const params = { incomingUsername: username, deeplinkNonce: nonce };
-      const targetKey = clientTabsKeyRef.current;
-      if (!targetKey) {
+      const currentRouteBefore = navRef.current.getCurrentRoute?.();
+      console.log(
+        "[deeplink] before navigate",
+        currentRouteBefore?.name,
+        currentRouteBefore?.key
+      );
+      const rootState = navRef.current.getRootState?.();
+      const targetKey = findSearchTabNavigatorKey(rootState);
+      if (targetKey) {
+        console.log("[deeplink] jumpTo Search target", targetKey);
+        navRef.current.dispatch({
+          ...TabActions.jumpTo("Search", params),
+          target: targetKey,
+        });
+        console.log("[deeplink] jumpTo dispatched", params);
+      } else {
         console.log("[deeplink] missing tabs key; jumpTo skipped");
-        return false;
       }
 
-      console.log("[deeplink] jumpTo Search target", targetKey);
-      navRef.current.dispatch({
-        ...TabActions.jumpTo("Search", params),
-        target: targetKey,
-      });
-      console.log("[deeplink] jumpTo dispatched", params);
+      setTimeout(() => {
+        navRef.current?.navigate("Search", params);
+        const currentRouteAfter = navRef.current?.getCurrentRoute?.();
+        console.log(
+          "[deeplink] after navigate",
+          currentRouteAfter?.name,
+          currentRouteAfter?.key
+        );
+      }, 0);
 
       return true;
     },
     []
   );
 
   const handleIncomingUrl = useCallback((url, source) => {
     console.log("[deeplink] handleIncomingUrl", source, url);
     if (DEEPLINK_DEBUG) showFlash("info", `[DL] ${source}: ${url || "(null)"}`);
     if (url && url === lastHandledUrlRef.current) {
       console.log("[deeplink] duplicate url ignored", url);
       return false;
     }
     const username = extractUsernameFromUrl(url);
     console.log("[deeplink] extracted username", username);
     if (!username) {
       if (DEEPLINK_DEBUG) showFlash("error", "[DL] parse failed");
       return false;
     }
     if (DEEPLINK_DEBUG) showFlash("success", `[DL] user: ${username}`);
     if (tokenRef.current?.isProvider === true) {
       showFlash("error", "Open as a client to view provider links.");
       return true;
     }
 
@@ -6526,51 +6530,50 @@ function App() {
             )}
 
             {authMode === "signup" && (
               <SignupScreen
                 goToLogin={() => setAuthMode("login")}
                 goBack={() => setAuthMode("landing")}
                 showFlash={showFlash}
               />
             )}
             {authMode === "forgot" && (
               <ForgotPasswordScreen
                 goToLogin={() => setAuthMode("login")}
                 goBack={() => setAuthMode("landing")}
                 showFlash={showFlash}
               />
             )}
           </>
         ) : (
           <MainApp
             apiClient={apiClient}
             authLoading={authLoading}
             token={token}
             setToken={setToken}
             showFlash={showFlash}
             navigationRef={navigationRef}
-            clientTabsKeyRef={clientTabsKeyRef}
             setNavReady={setNavReady}
           />
         )}
       </SafeAreaView>
     </SafeAreaProvider>
   );
 }
 
 
 
 
 const styles = StyleSheet.create({
   container: {
     flex: 1,
     backgroundColor: colors.background,
     justifyContent: "center",
     alignItems: "center",
     padding: 20,
   },
   title: {
     fontSize: 36,
     fontWeight: "bold",
     color: colors.textPrimary,
     marginBottom: 20,
   },
 
EOF
)