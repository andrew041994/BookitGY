 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/backend/app/routes/profile.py b/backend/app/routes/profile.py
index b86147e35a95223ff9c58bd49e673a46b011bf8e..69562bf7553cddfea5765b55454e5a677f8d9a76 100644
--- a/backend/app/routes/profile.py
+++ b/backend/app/routes/profile.py
@@ -1,30 +1,31 @@
 from typing import Optional, List
 from urllib.parse import urlparse
 
 from fastapi import APIRouter, Depends, HTTPException, status
 from sqlalchemy.orm import Session
+from sqlalchemy.exc import IntegrityError
 
 from app.database import get_db
 from app import models, schemas, crud
 from app.config import get_settings
 from app.security import get_current_user_from_header
 
 settings = get_settings()
 
 router = APIRouter(tags=["profile"])
 
 MAX_AVATAR_URL_LENGTH = 500
 
 
 def _sanitize_avatar_url(raw_url: str) -> str:
     """
     Validate and normalize an avatar URL before saving it.
 
     - Rejects empty/whitespace-only values.
     - Requires http:// or https:// scheme.
     - Enforces a max length to avoid abuse payloads.
     """
     if raw_url is None:
         return None
 
     url = raw_url.strip()
@@ -132,51 +133,61 @@ def update_my_provider_profile(
     if payload.phone is not None:
         user.phone = payload.phone
 
     if payload.whatsapp is not None:
         user.whatsapp = payload.whatsapp
 
     if payload.location is not None:
         user.location = payload.location
 
     # Update provider bio
     if payload.bio is not None:
         provider.bio = payload.bio
 
     # Update avatar URL (sanitized)
     if payload.avatar_url is not None:
         provider.avatar_url = _sanitize_avatar_url(payload.avatar_url)
 
     # Update professions if provided
     if payload.professions is not None:
         professions = crud.set_professions_for_provider(
             db, provider.id, payload.professions
         )
     else:
         professions = crud.get_professions_for_provider(db, provider.id)
 
-    db.commit()
+    try:
+        db.commit()
+    except IntegrityError as exc:
+        db.rollback()
+        detail = str(getattr(exc, "orig", exc))
+        if "users_username_lower_unique" in detail:
+            raise HTTPException(
+                status_code=status.HTTP_400_BAD_REQUEST,
+                detail="Username already taken",
+            )
+        raise
     db.refresh(user)
     db.refresh(provider)
 
     return schemas.ProviderProfileOut(
         full_name=crud.get_display_name(user),
         phone=user.phone or "",
         whatsapp=user.whatsapp,
         location=user.location or "",
         bio=provider.bio or "",
         professions=professions,
         avatar_url=provider.avatar_url,
     )
 
 
 # =====================================================================
 #  WORKING HOURS
 # =====================================================================
 
 
 @router.post(
     "/providers/me/hours",
     response_model=List[schemas.WorkingHoursOut],
     status_code=status.HTTP_200_OK,
 )
 def update_my_working_hours(
 
EOF
)