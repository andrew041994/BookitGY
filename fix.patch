 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/mobile/plugins/strip-pods-privacyinfo.js b/mobile/plugins/strip-pods-privacyinfo.js
index 6f183d13de32852b3f13accb4173e52265dfb977..1fec004e58c72ddc51ae26f3276ee20785e50d09 100644
--- a/mobile/plugins/strip-pods-privacyinfo.js
+++ b/mobile/plugins/strip-pods-privacyinfo.js
@@ -101,121 +101,144 @@ function processPbxproj(pbxprojPath) {
   );
   updated = buildFilesStrip.content;
 
   const fileRefsStrip = stripEntries(updated, fileRefsToRemove, "PrivacyInfo.xcprivacy");
   updated = fileRefsStrip.content;
 
   const resourcesStrip = stripResourcesReferences(updated, buildFilesToRemove);
   updated = resourcesStrip.content;
 
   if (updated !== original) {
     fs.writeFileSync(pbxprojPath, updated);
   }
 
   const totalRemoved = buildFilesStrip.removed + fileRefsStrip.removed + resourcesStrip.removed;
   console.log(
     `[strip-pods-privacyinfo] Removed ${totalRemoved} PrivacyInfo.xcprivacy references from ${path.relative(
       process.cwd(),
       pbxprojPath
     )}`
   );
 }
 
 function buildPodfileSnippet(indent) {
   const lines = [
     `${indent}${PODFILE_MARKER}`,
-    `${indent}scripts = Dir.glob(File.join(__dir__, "Pods", "Target Support Files", "Pods-*", "Pods-*-resources.sh"))`,
+    `${indent}pods_project = installer.pods_project`,
     "",
-    `${indent}scripts.each do |script|`,
-    `${indent}  next unless File.exist?(script)`,
-    `${indent}  content = File.read(script)`,
-    `${indent}  next unless content.include?("PrivacyInfo.xcprivacy")`,
+    `${indent}removed = 0`,
+    `${indent}pods_project.targets.each do |t|`,
+    `${indent}  phase = t.resources_build_phase`,
+    `${indent}  next unless phase && phase.files`,
     "",
-    `${indent}  filtered = content.lines.reject { |line| line.include?("PrivacyInfo.xcprivacy") }.join`,
-    `${indent}  File.write(script, filtered)`,
+    `${indent}  phase.files.to_a.each do |bf|`,
+    `${indent}    ref = bf.file_ref`,
+    `${indent}    next unless ref && ref.path`,
+    `${indent}    next unless ref.path.end_with?("PrivacyInfo.xcprivacy")`,
     "",
-    `${indent}  puts "[BookitGY] Stripped PrivacyInfo.xcprivacy from #{script}"`,
+    `${indent}    phase.remove_build_file(bf)`,
+    `${indent}    removed += 1`,
+    `${indent}  end`,
     `${indent}end`,
     "",
+    `${indent}pods_project.save`,
+    `${indent}puts "[BookitGY] Removed #{removed} PrivacyInfo.xcprivacy resource refs from Pods project"`,
+    "",
   ];
 
   return lines.join("\n");
 }
 
 function findPostInstallEnd(content, startIndex) {
   const remainder = content.slice(startIndex);
   const lines = remainder.split("\n");
   let depth = 0;
   let position = startIndex;
 
   for (const line of lines) {
     const lineStart = position;
     const doCount = (line.match(/\bdo\b/g) || []).length;
     const endCount = (line.match(/\bend\b/g) || []).length;
 
     depth += doCount;
     depth -= endCount;
 
     if (depth === 0) {
       return lineStart;
     }
 
     position += line.length + 1;
   }
 
   return null;
 }
 
 function injectPodfilePrivacyStrip(iosDir) {
   const podfilePath = path.join(iosDir, "Podfile");
   if (!fs.existsSync(podfilePath)) {
     return;
   }
 
   let podfileContent = fs.readFileSync(podfilePath, "utf8");
 
-  if (podfileContent.includes(PODFILE_MARKER)) {
-    return;
-  }
-
   const postInstallMatch = podfileContent.match(/^[ \t]*post_install\s+do\s*\|[^|]*\|.*$/m);
 
   if (postInstallMatch) {
     const postInstallStart = postInstallMatch.index;
     const endOfPostInstall = findPostInstallEnd(podfileContent, postInstallStart);
 
     if (endOfPostInstall === null) {
       return;
     }
 
     const indent = postInstallMatch[0].match(/^[ \t]*/)[0];
     const snippet = buildPodfileSnippet(`${indent}  `);
     const before = podfileContent.slice(0, endOfPostInstall);
     const after = podfileContent.slice(endOfPostInstall);
-    const needsLeadingNewline = before.endsWith("\n") ? "" : "\n";
 
-    podfileContent = `${before}${needsLeadingNewline}${snippet}${after}`;
+    let cleanedBefore = before;
+    if (before.includes(PODFILE_MARKER)) {
+      const snippetIndex = before.indexOf(snippet);
+      if (snippetIndex !== -1) {
+        cleanedBefore =
+          before.slice(0, snippetIndex) + before.slice(snippetIndex + snippet.length);
+      } else {
+        const lines = before.split("\n");
+        const markerIndex = lines.findIndex((line) => line.includes(PODFILE_MARKER));
+        if (markerIndex !== -1) {
+          cleanedBefore = lines.slice(0, markerIndex).join("\n");
+        }
+      }
+
+      if (!cleanedBefore.endsWith("\n")) {
+        cleanedBefore += "\n";
+      }
+    }
+
+    const needsLeadingNewline = cleanedBefore.endsWith("\n") ? "" : "\n";
+
+    podfileContent = `${cleanedBefore}${needsLeadingNewline}${snippet}${after}`;
   } else {
     const snippet = buildPodfileSnippet("  ");
     const needsLeadingNewline = podfileContent.endsWith("\n") ? "" : "\n";
 
     podfileContent = `${podfileContent}${needsLeadingNewline}post_install do |installer|\n${snippet}end\n`;
   }
 
   fs.writeFileSync(podfilePath, podfileContent);
 
   console.log(
     `[strip-pods-privacyinfo] Injected Podfile privacy strip logic into ${path.relative(
       process.cwd(),
       podfilePath
     )}`
   );
 }
 
 module.exports = function withStripPodsPrivacyInfo(config) {
   return withDangerousMod(config, [
     "ios",
     async (config) => {
       const iosDir = config.modRequest.platformProjectRoot;
       const pbxprojPaths = findPbxprojFiles(iosDir);
 
       for (const pbxprojPath of pbxprojPaths) {
 
EOF
)