require File.join(File.dirname(`node --print "require.resolve('expo/package.json')"`), "scripts/autolinking")
require File.join(File.dirname(`node --print "require.resolve('react-native/package.json')"`), "scripts/react_native_pods")

require "json"

podfile_properties_path = File.join(__dir__, "Podfile.properties.json")
podfile_properties = JSON.parse(File.read(podfile_properties_path)) rescue {}

def ccache_enabled?(podfile_properties)
  # Environment variable takes precedence
  return ENV["USE_CCACHE"] == "1" if ENV["USE_CCACHE"]
  podfile_properties["apple.ccacheEnabled"] == "true"
end

# Keep behavior aligned with Podfile.properties.json
ENV["RCT_NEW_ARCH_ENABLED"] ||= "0" if podfile_properties["newArchEnabled"] == "false"
ENV["EX_DEV_CLIENT_NETWORK_INSPECTOR"] ||= podfile_properties["EX_DEV_CLIENT_NETWORK_INSPECTOR"]

platform :ios, "13.4"

prepare_react_native_project!

# Optional: allow frameworks linkage via Podfile.properties.json
use_frameworks! :linkage => :static if podfile_properties["ios.useFrameworks"] == "static"
use_frameworks! :linkage => :dynamic if podfile_properties["ios.useFrameworks"] == "dynamic"

target "BookitGY" do
  use_expo_modules!

  config = use_native_modules!

  # Hermes based on expo.jsEngine
  hermes_enabled = (podfile_properties["expo.jsEngine"] == "hermes")

  use_react_native!(
    :path => config[:reactNativePath],
    :hermes_enabled => hermes_enabled,
    :app_path => "#{Pod::Config.instance.installation_root}/.."
  )

  post_install do |installer|
    react_native_post_install(
      installer,
      config[:reactNativePath],
      :mac_catalyst_enabled => false,
      :ccache_enabled => ccache_enabled?(podfile_properties)
    )

    # âœ… Prevent duplicate PrivacyInfo.xcprivacy being copied from Pods into the app bundle
    installer.pods_project.targets.each do |t|
      next unless t.respond_to?(:resources_build_phase)

      phase = t.resources_build_phase
      next unless phase

      phase.files.each do |f|
        name = f.display_name
        next unless name && name.end_with?("PrivacyInfo.xcprivacy")
        f.remove_from_project
      end
    end
  end
end
