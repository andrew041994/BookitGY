require File.join(File.dirname(`node --print "require.resolve('expo/package.json')"`), "scripts/autolinking")
require File.join(File.dirname(`node --print "require.resolve('react-native/package.json')"`), "scripts/react_native_pods")

require "json"

podfile_properties_path = File.join(__dir__, "Podfile.properties.json")
podfile_properties = JSON.parse(File.read(podfile_properties_path)) rescue {}

# Force a single minimum iOS version everywhere (Pods + app)
platform :ios, "16.0"

install! "cocoapods", :deterministic_uuids => false


prepare_react_native_project!

target "BookitGY" do
  use_expo_modules!

  config = use_native_modules!

  use_react_native!(
    :path => config[:reactNativePath],
    :hermes_enabled => podfile_properties["expo.jsEngine"] == "hermes",
    :fabric_enabled => podfile_properties["newArchEnabled"] == "true",
    :app_path => "#{Pod::Config.instance.installation_root}/.."
  )

      post_install do |installer|
      react_native_post_install(
        installer,
        config[:reactNativePath],
        :mac_catalyst_enabled => false
      )
    
      deployment_target = "16.0"
    
      # 1) Force ALL Pods targets to iOS 16.0
      installer.pods_project.targets.each do |t|
        t.build_configurations.each do |bc|
          bc.build_settings["IPHONEOS_DEPLOYMENT_TARGET"] = deployment_target
        end
      end
    
      # 2) Force the USER project (BookitGY app target) to iOS 16.0
      installer.aggregate_targets.each do |agg|
        agg.user_project.targets.each do |t|
          t.build_configurations.each do |bc|
            bc.build_settings["IPHONEOS_DEPLOYMENT_TARGET"] = deployment_target
          end
        end
      end

      # 3) Also bump the project-level setting (some templates rely on this)
      installer.aggregate_targets.each do |agg|
        agg.user_project.build_configurations.each do |bc|
          bc.build_settings["IPHONEOS_DEPLOYMENT_TARGET"] = deployment_target
        end
        agg.user_project.save
      end
    end


  post_integrate do |installer|
    begin
      expo_patch_react_imports!(installer) if defined?(expo_patch_react_imports!)
    rescue => e
      Pod::UI.warn e
    end

    # BOOKITGY_PRIVACYINFO_STRIP
    removed = 0

    # 1) Strip from resources shell scripts
    scripts = Dir.glob(File.join(__dir__, "Pods", "Target Support Files", "**", "*-resources.sh"))
    scripts.each do |p|
      next unless File.exist?(p)
      c = File.read(p)
      next unless c.include?("PrivacyInfo.xcprivacy")
      n = c.lines.reject { |line| line.include?("PrivacyInfo.xcprivacy") }.join
      if n != c
        removed += (c.lines.length - n.lines.length)
        File.write(p, n)
      end
    end

    # 2) Strip from xcfilelists (these drive Xcode output tracking)
    filelists = Dir.glob(File.join(__dir__, "Pods", "Target Support Files", "**", "*resources-*-files.xcfilelist"))
    filelists.each do |p|
      next unless File.exist?(p)
      c = File.read(p)
      next unless c.include?("PrivacyInfo.xcprivacy")
      n = c.lines.reject { |line| line.include?("PrivacyInfo.xcprivacy") }.join
      if n != c
        removed += (c.lines.length - n.lines.length)
        File.write(p, n)
      end
    end

    puts "[BookitGY] Stripped #{removed} PrivacyInfo.xcprivacy references from CocoaPods resources scripts/filelists"
  end
end
